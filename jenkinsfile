#!groovy
pipeline {
    agent {
          node {
              label "Centos"
          }
    }
    environment {
      repoUrl = "http://52.163.243.66:8081/gitlab-instance-f390ce36/jadegit_azaas.git"
    }
    parameters {
      string(name:'repoBranch', defaultValue: '', description: 'git分支名称')  
    }
    triggers {
      GenericTrigger(
              genericVariables: [
                [key: 'branch', value: '$.ref']
              ],
              token: '_ZjfkjTZJAEg5seBtEts' ,
              causeString: ' Triggered on $branch' ,
              printContributedVariables: true,
              printPostContent: true
          )
    }
    stages {
      stage('getBranch'){
          steps{
            script{
                      try{                    
              if("${branch}" != ""){ 
                println "----------webhook式触发-----------"
                branchName = branch
                branchName = sh(returnStdout: true,script: "echo ${branchName}|awk -F '/' '{print \$NF}'").trim()
                println "webhook触发的分支是: " + "${branchName}"
              }
            } catch(exc) { }           
              if("${params.repoBranch}" != ""){
                println "-----------手动方式触发------------"
                branchName = "${params.repoBranch}"
                println "手动触发的分支是: " + "${branchName}"
          stage('gethashcode'){
            steps{
              script{
                env.imageTag = sh (script: 'git rev-parse --short HEAD ${GIT_COMMIT}', returnStdout: true).trim()
                env.GIT_COMMIT_MSG = sh (script: 'git log -1 --pretty=%B ${GIT_COMMIT}', returnStdout: true).trim()
                echo ${imageTag}
                echo ${GIT_COMMIT_MSG}
              }
            }
          }
              } 
            }}
      }
  }    
  }
   
  
